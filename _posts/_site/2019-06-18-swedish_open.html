<h1 id="swedish-open">Swedish Open</h1>
<p>NOTE! The scans are done solely in the purpose of research. Any issues I find have been reported in a responsible manner and no sensitive data is stored. I suggest to all organisations to keep track of their Internet connected services. Scanning their own IP blocks (IPv4 and IPv6). You can reach out to me at twitter <a href="https://twitter.com/bewniac">@bewniac</a>.</p>

<h2 id="dns-udp-53">DNS udp 53</h2>
<p>I’m trying to get more into DNS and wanted to do some research on open resolvers in Sweden. First I wanted to get a list of all Swedish registred IP blocks, which is listed <a href="http://ipverse.net/ipblocks/data/countries/se.zone">here</a>. I haven’t checked it against other lists and it might now be fully complete but for my purpose it’s good enough.</p>

<p>So first I want to get all servers running DNS (UDP port 53). I used <a href="https://github.com/robertdavidgraham/masscan">masscan</a>, which is a really fast Internet port scanner.</p>

<p>By setting the rate to 100 000 I can scan the Swedish IP blocks in under five minutes.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>masscan --rate=100000 -pU:53 -iL se.zone -oA sweden.dns.servers
grep "open" sweden.dns.servers | awk '{print $4}' &gt; sweden.dns.ip
</code></pre></div></div>

<p>Next I wanted to find which servers are open resolvers. You can do this by sending a TXT query for “test.openresolver.com” to the nameserver. I wrote a simple python script to do this.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">dns.resolver</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"Usage : "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">" [IP list of DNS servers to check] [output file]"</span><span class="p">)</span>
	<span class="nb">exit</span><span class="p">()</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"r"</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"w"</span><span class="p">)</span>
<span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">default_resolver</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">Resolver</span><span class="p">(</span><span class="n">configure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">default_resolver</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">default_resolver</span><span class="o">.</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="s">"Trying server: "</span> <span class="o">+</span> <span class="n">ip</span><span class="p">);</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">default_resolver</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span>
		<span class="n">answer</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">"test.openresolver.com"</span><span class="p">,</span> <span class="s">"TXT"</span><span class="p">)</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="k">continue</span>

	<span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
		<span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>Now I got a list with all open DNS resolvers in Sweden. So what can I do with this information?</p>

<h3 id="axfr-transfer">AXFR Transfer</h3>
<p>AXFR is an old method to sync zone files between nameservers. This shouldn’t be possible to do from Internet. In some misconfigurations this unfortunately true and anyone can ask for the zonefile for a specific domain. I ran some tests to check if there was possible to transfer the zonefile.</p>

<p>First I did a reverse lookup to see which domain the nameservers are in. They can have multiple domains, but this is just a simple check-up.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for ns in `cat sweden.open.resolvers`; do rev=`dig +time=1 +short +answer -x $ns @$ns`; echo $ns" "$rev done | tee sweden.open.resolvers.reverse
</code></pre></div></div>

<p>Filter out the top domain and the domain name with the IP address.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk -F'[ ]' 'NF == 3 {print $1" "$3}' sweden.open.resolvers.reverse | awk -F'[ .]' '{print $1"."$2"."$3"."$4" "$(NF-2)"."$(NF-1)}' &gt; sweden.openresolvers.ns.domain
</code></pre></div></div>

<p>Let’s see if zone-transfer is enabled.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk '{print "dig +time=1 +short -t axfr @"$1" "$2}' sweden.openresolvers.ns.domain &gt; axfr.commands
while read cmd; do echo $cmd; $cmd; done &lt;axfr.commands &gt; axfr.result
</code></pre></div></div>
<h3 id="other-findings">Other findings</h3>
<p>When I did the reverse lookup I found a lot of A records named <code class="highlighter-rouge">asus.router.com</code>, <code class="highlighter-rouge">dsldevice.lan</code>, <code class="highlighter-rouge">router.lan</code> and other <code class="highlighter-rouge">.lan</code> devices which tells me they’re not supposed to be exposed on the internet.</p>

<h2 id="rdp-tcp-3389">RDP tcp 3389</h2>
<p>On thing about Remote Desktop Protocol (RDP) is that it should never ever be accessible from the Internet. So let see how many RDP servers are running in Sweden accessible to Internet.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>masscan --rate=100000 -p3389 -iL se.zone -oG RDP/sweden.3389.scan
</code></pre></div></div>

<p>The result shows there’s almost 2 000 servers running RDP in Sweden.</p>

<p>I’m not comfortable to do anything more with this. You could take screen shots of the login screens to gather intel about users. You could start bruteforcing passwords. One extremely bad vulnerability was disclosed this year (2019) called <code class="highlighter-rouge">BlueKeep</code> or <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-0708">CVE-2019-0708</a>. It already exists metasploit modules for checking if the system is vulnerable and there will probably be more PoC’s actually exploiting this vulnerability in the wild. Watch out!</p>
